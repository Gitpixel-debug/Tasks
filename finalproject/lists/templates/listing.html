<!-- listing.html -->

{% extends 'layout.html' %}
{% load tz %}

{% block title %}{{ listing.title }}{% endblock %}

{% block body %}
  <div class="container mt-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="card-title d-flex justify-content-between align-items-center">
          {{ listing.title }}
          {% if listing.deadline_passed and listing.percentage < 100 %}
            <span class="badge badge-danger" style="font-size: 1.2rem; padding: 0.4em 0.7em;">⏰ Deadline Passed</span>
          {% elif listing.closing_soon and listing.percentage < 100 %}
            <span class="badge badge-warning" style="font-size: 1.2rem; padding: 0.4em 0.7em;">⚠️ Due Soon</span>
          {% elif listing.percentage == 100 %}
            <span class="badge badge-success" style="font-size: 1.2rem; padding: 0.4em 0.7em;">✅ Completed</span>
          {% endif %}
        </h2>
        <hr>

        {% if listing.description %}
          <h4>Description:</h4>
          <p>{{ listing.description }}</p>
          <br>
        {% endif %}
        {% if user.is_authenticated %}
            {% if user in listing.signed_up.all %}
                <label for="progress">Progress: (percentage)</label><br>
                <form>
                    <div class="form-group" style="margin-bottom: 1%;">
                        <input class="form-control" type="number" value="{{ listing.percentage }}" id="progress" name="progress" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="submit">Change</button>
                </form>
            {% endif %}
        {% endif %}
        <div style="display: inline-flex; align-items: center;">
        <p style="margin: 0; padding-right: 10px;">Progress: </p>
        <progress
            id="progress_bar"
            value="{{ listing.percentage }}"
            max="100"
            style="height: 60px; width: 500px;"
            data-listing-id="{{ listing.my_id }}"
        ></progress>
        </div>
        <hr>
        <h4>Comments</h4>
        <hr>
        {% for comment in comments %}
            <h4>{{ comment.title }} - {{ comment.author }}</h4>
            <p style="margin-bottom: 2%;">{{ comment.content }}</p>
            <hr>
        {% empty %}
            <h4>No comments yet</h4>
        {% endfor %}
        {% if user.is_authenticated %}
            <br>
            <!-- Updated URL name here -->
            <form action="{% url 'listing_detail' listing.my_id %}" method="POST">
                {% csrf_token %}
                <div class="form-group">
                    <input class="form-control" type="text" name="title" placeholder="Title" required>
                </div>
                <div class="form-group">
                    <input class="form-control" type="text" name="description" placeholder="Description" required>
                </div>
                <input class="btn btn-primary" type="submit" value="Comment">
            </form>
        {% endif %}
        <hr>
        <h4>Signed Up</h4>
        {% if listing.signed_up.all %}
          <ul class="list-group mb-3">
            {% for person in listing.signed_up.all %}
              <li class="list-group-item">{{ person.username }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="alert alert-info">No one has signed up yet.</div>
        {% endif %}

        {% if user.is_authenticated %}
          {% if user not in listing.signed_up.all %}
            <form action="{% url 'add_to_listing' listing.my_id %}" method="post">
              {% csrf_token %}
              <button type="submit" class="btn btn-primary">Sign Up</button>
            </form>
          {% else %}
            <form action="{% url 'remove_from_listing' listing.my_id %}" method="post">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">Remove</button>
            </form>
          {% endif %}
        {% endif %}

        <div class="mt-4">
          <h6><strong>Deadline:</strong> {{ listing.deadline|localtime }}</h6>
          <small class="text-muted">{{ listing.timestamp|localtime }}</small>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const progressBar = document.getElementById('progress_bar');
        const progressInput = document.getElementById('progress');
        const submitBtn = document.getElementById('submit');
        const listingId = progressBar.dataset.listingId;
        console.log('loaded')
        submitBtn.addEventListener('click', function() {
            const progressValue = progressInput.value;
            console.log('clicked')
            // The fetch URL structure matches the urls.py definition for 'update_progress'
            fetch(`update/${listingId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    progress_value: progressValue
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data)
                progressBar.value = progressValue;
            })
            .catch(error => {
                console.error(`Error: ${error}`)
            })
        })
    })
  </script>
{% endblock %}
